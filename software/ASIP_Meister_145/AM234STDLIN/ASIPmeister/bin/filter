#! /usr/bin/perl
#######################################################################
#                                                                     #
#   Copyright (C) 2011 ASIP Solutions, Inc. All rights reserved.      #
#                Copyright (C) 2002-2005 PEAS Project                 #
#                                                                     #
#######################################################################

while ($file = glob("*.vhd")) {
  open (IN, "$file");

  $out_str = "";

  while (<IN>) {
    if (length($_) > 72) {
      $len = 0;
      $str = "";
      $comment = 0;
      if (substr($_,0,2) eq "--") {
	$comment = 1;
      }
      elsif (substr($_,0,2) eq "  ") {
	$str = "  ";
      }
      elsif (substr($_,0,1) eq "\t") {
	$str = "\t";
      }
      @elements = split;
      $first = 1;
      foreach $each_elem (@elements) {
	$len += 1+length($each_elem);
	if (substr($each_elem,0,2) eq "--") {
	  $comment = 1;
	}
	if ($len < 72) {
	  if ($first == 0) {
	    $str .= " ".$each_elem;
	  }
	  else {
	    $str .= $each_elem;
	    $first = 0;
	  }
	}
	else {
	  if ($comment == 1) {
	    $str .= "\n--  \t".$each_elem;
	  }
	  else {
	    $str .= "\n  \t".$each_elem;
	  }
	  $len = length($each_elem);
	}
      }
      $out_str .= $str."\n";
    }
    else {
      $out_str .= $_;
    }
  }
  close IN;

  open(OUT,">$file");

  print OUT $out_str;

  print OUT "\n";
  print OUT "-----------------------------------------\n";
  print OUT "-- Generated by ASIP Meister ver.2.3.4 --\n";
  print OUT "-----------------------------------------\n";

  close OUT;
}

while ($file = glob("*.v")) {
  open (IN, "$file");

  $out_str = "";

  while (<IN>) {
    if (length($_) > 72) {
      $len = 0;
      $str = "";
      $comment = 0;
      if (substr($_,0,2) eq "//") {
	$comment = 1;
      }
      elsif (substr($_,0,2) eq "  ") {
	$str = "  ";
      }
      elsif (substr($_,0,1) eq "\t") {
	$str = "\t";
      }
      @elements = split;
      $first = 1;
      foreach $each_elem (@elements) {
	$len += 1+length($each_elem);
	if (substr($each_elem,0,2) eq "//") {
	  $comment = 1;
	}
	if ($len < 72) {
	  if ($first == 0) {
	    $str .= " ".$each_elem;
	  }
	  else {
	    $str .= $each_elem;
	    $first = 0;
	  }
	}
	else {
	  if ($comment == 1) {
	    $str .= "\n//  \t".$each_elem;
	  }
	  else {
	    $str .= "\n  \t".$each_elem;
	  }
	  $len = length($each_elem);
	}
      }
      $out_str .= $str."\n";
    }
    else {
      $out_str .= $_;
    }
  }
  close IN;

  open(OUT,">$file");

  print OUT $out_str;

  close OUT;
}

while ($file = glob("*.scr")) {
  open (IN, "$file");
  open (OUT, ">>$file");
  print OUT "\n";
  print OUT "/**************************************\n";
  print OUT "* Generated by ASIP Meister ver.2.3.4 * \n";
  print OUT "**************************************/\n";
  close IN;
  close OUT;
}
